<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    Laravel实例详解之容器、控制反转和依赖注入 | Hexo
  </title>
  <meta name="description" content="">
  
  <meta name="keywords" content="
  Laravel
  ">
  
  <meta name="author" content="Bxl">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="theme-color" content="#1e2327">
  <link rel="apple-touch-icon" href="https://github.githubassets.com/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://github.githubassets.com/apple-touch-icon-180x180.png">

  <link rel="icon" type="image/x-icon" href="https://github.githubassets.com/favicon.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  

  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
<meta name="generator" content="Hexo 6.2.0"></head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/archives">Archives</a></li>
        
        
        <li><a href="/categories">Categories</a></li>
        
        
        <li><a href="/tags">Tags</a></li>
        
        
        <li class="desktop-only"><a href="/atom.xml" target="_blank">RSS</a></li>
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="https://octodex.github.com/images/baracktocat.jpg"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/archives"
           class="header-toolbar-right"> 6 </a>
      </li>
      <li>
        <a href="/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/tags"
           class="header-toolbar-right"> 4 </a>
      </li>
      <li>
        <a href="/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/categories"
           class="header-toolbar-right"> 3 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/">Hexo</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    Bxl

    <span class="post-date float-right" title="{{moment(1631349693000).format('MMM DD, YYYY, h:mm:ss A')}}">
      
          <i class="fa fa-pencil-square-o"></i>
      
      {{moment(1631349693000).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>Laravel实例详解之容器、控制反转和依赖注入</h1>
    <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前面在研究 <a href="https://b3296.github.io/2021/08/04/laravel-life-cycle/">Laravel 生命周期</a> 时,<br>对服务容器没有太细致的分析，本篇文章就当做对它的补充，顺便学习下Laravel的控制反转和依赖注入。</p>
<p>随着现在应用的规模越来越庞大，对象之间的依赖关系也越来越复杂，耦合程度越来越高，经常会出现对象之间多重依赖的情况。对于如此庞大复杂的应用，任何修改都可能会牵一发而动全身，这就为应用的后期维护造成了很多困扰。</p>
<p>为了解决对象之间耦合度高的问题，控制反转（IoC）的思想也随之诞生。所谓控制反转，是面向对象编程中的一种设计原则，其目的是为了降低代码之间的耦合程度。在 Laravel 中，控制反转是通过依赖注入（DI）的方式实现的。</p>
<p>控制反转的基本思想是借助 IoC 容器实现对象之间的依赖关系的解耦。引入 IoC 容器之后，所有对象的控制权都上交给 IoC 容器，IoC 容器成了整个系统的核心，把所有对象粘合在一起发挥作用。Laravel 中的容器即起到了这个作用。</p>
<h1 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h1><p>所谓容器，在 Laravel 中指的是 \Illuminate\Foundation\Application 对象，Laravel 框架在启动时即创建了该对象。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># public/index.php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span> = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">&#x27;/../bootstrap/app.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># bootstrap/app.php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span> = <span class="keyword">new</span> <span class="title class_">Illuminate\Foundation\Application</span>(</span><br><span class="line">    <span class="variable">$_ENV</span>[<span class="string">&#x27;APP_BASE_PATH&#x27;</span>] ?? <span class="title function_ invoke__">dirname</span>(<span class="keyword">__DIR__</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>在创建容器的过程中，Laravel 还会对容器进行一些基础的绑定和服务注册。Laravel 首先会将容器实例与 app 和 Illuminate\Container\Container 进行绑定；之后，Laravel 会将基础的服务提供者注册到容器实例中，包括事件、日志、路由服务提供者；最后，Laravel 会将框架核心 class 与其相对应的别名一起注册到容器实例当中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Foundation\Application</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$basePath</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$basePath</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setBasePath</span>(<span class="variable">$basePath</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerBaseBindings</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerBaseServiceProviders</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerCoreContainerAliases</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseBindings</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static</span>::<span class="title function_ invoke__">setInstance</span>(<span class="variable">$this</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;app&#x27;</span>, <span class="variable">$this</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="title class_">Container</span>::<span class="variable language_">class</span>, <span class="variable">$this</span>);</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseServiceProviders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">register</span>(<span class="keyword">new</span> <span class="title class_">EventServiceProvider</span>(<span class="variable">$this</span>));</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">register</span>(<span class="keyword">new</span> <span class="title class_">LogServiceProvider</span>(<span class="variable">$this</span>));</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">register</span>(<span class="keyword">new</span> <span class="title class_">RoutingServiceProvider</span>(<span class="variable">$this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerCoreContainerAliases</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ([</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span> =&gt; [<span class="built_in">self</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Container\Container</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Foundation\Application</span>::<span class="variable language_">class</span>, <span class="title class_">\Psr\Container\ContainerInterface</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="comment">/* ... ...*/</span></span><br><span class="line">        <span class="string">&#x27;db&#x27;</span> =&gt; [<span class="title class_">\Illuminate\Database\DatabaseManager</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Database\ConnectionResolverInterface</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;db.connection&#x27;</span> =&gt; [<span class="title class_">\Illuminate\Database\Connection</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Database\ConnectionInterface</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="comment">/* ... ... */</span></span><br><span class="line">        <span class="string">&#x27;request&#x27;</span> =&gt; [<span class="title class_">\Illuminate\Http\Request</span>::<span class="variable language_">class</span>, <span class="title class_">\Symfony\Component\HttpFoundation\Request</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;router&#x27;</span> =&gt; [<span class="title class_">\Illuminate\Routing\Router</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Routing\Registrar</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Routing\BindingRegistrar</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="comment">/* ... ... */</span></span><br><span class="line"></span><br><span class="line">    ] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$aliases</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$aliases</span> <span class="keyword">as</span> <span class="variable">$alias</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">alias</span>(<span class="variable">$key</span>, <span class="variable">$alias</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// namespace Illuminate\Container\Container</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">alias</span>(<span class="params"><span class="variable">$abstract</span>, <span class="variable">$alias</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$alias</span> === <span class="variable">$abstract</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">LogicException</span>(<span class="string">&quot;[<span class="subst">&#123;$abstract&#125;</span>] is aliased to itself.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;aliases[<span class="variable">$alias</span>] = <span class="variable">$abstract</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;abstractAliases[<span class="variable">$abstract</span>][] = <span class="variable">$alias</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在完成这三步基本的注册之后，我们可以很方便的访问已经注册到容器中的对象实例。例如，可以直接通过 $app[‘app’] 或 $app[‘Illuminate\Container\Container’] 访问容器本身，还可以通过 $app[‘db’] 直接访问数据库连接。</p>
<h1 id="服务提供者的注册以及服务的访问"><a href="#服务提供者的注册以及服务的访问" class="headerlink" title="服务提供者的注册以及服务的访问"></a>服务提供者的注册以及服务的访问</h1><h2 id="注册服务提供者"><a href="#注册服务提供者" class="headerlink" title="注册服务提供者"></a>注册服务提供者</h2><p>在容器创建的过程中会注册基础服务提供者，其注册过程通过调用 register() 方法完成。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Foundation\Application</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$provider</span>, <span class="variable">$force</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="variable">$registered</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getProvider</span>(<span class="variable">$provider</span>)) &amp;&amp; ! <span class="variable">$force</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$registered</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$provider</span>)) &#123;</span><br><span class="line">        <span class="variable">$provider</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resolveProvider</span>(<span class="variable">$provider</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$provider</span>-&gt;<span class="title function_ invoke__">register</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">property_exists</span>(<span class="variable">$provider</span>, <span class="string">&#x27;bindings&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$provider</span>-&gt;bindings <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">bind</span>(<span class="variable">$key</span>, <span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">property_exists</span>(<span class="variable">$provider</span>, <span class="string">&#x27;singletons&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$provider</span>-&gt;singletons <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">singleton</span>(<span class="variable">$key</span>, <span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">markAsRegistered</span>(<span class="variable">$provider</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isBooted</span>()) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">bootProvider</span>(<span class="variable">$provider</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$provider</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Laravel 首先会判断指定的服务提供者是否已经在容器中注册（通过调用 getProvider() 方法实现），如果指定的服务提供者已经在容器中注册，并且本次注册操作并非强制执行，那么直接返回已经注册好的服务提供者。</p>
<p>如果不满足上述条件，那么 Laravel 就会开始注册服务提供者。此时，如果传参为字符串，那么 Laravel 会默认参数为服务提供者的 class 名称并进行实例化（通过 resolveProvider() 方法实现）。之后，就会调用服务提供者定义的 register() 方法进行注册。以日志服务提供者为例，其 register() 方法的方法体如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Log\LogServiceProvider</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">singleton</span>(<span class="string">&#x27;log&#x27;</span>, function (<span class="variable">$app</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LogManager</span>(<span class="variable">$app</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>register() 方法的作用就是将 Illuminate\Log\LogManager 对象以单例的模式注册到容器当中，注册完成之后，容器的 $bindings 属性中会增加一项</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$app</span>-&gt;bindings[<span class="string">&#x27;log&#x27;</span>] = [</span><br><span class="line">    <span class="string">&#x27;concrete&#x27;</span> =&gt; <span class="string">&#x27;Illuminate\Log\LogManager &#123;#162&#125;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;shared&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// namespace Illuminate\Container</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params"><span class="variable">$abstract</span>, <span class="variable">$concrete</span> = <span class="literal">null</span>, <span class="variable">$shared</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;bindings[<span class="variable">$abstract</span>] = <span class="title function_ invoke__">compact</span>(<span class="string">&#x27;concrete&#x27;</span>, <span class="string">&#x27;shared&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果服务提供者自身还定义了 $bindings 属性以及 $singletons 属性，那么 Laravel 还会调用相应的 bind() 方法和 singleton() 方法完成这些服务提供者自定义的绑定的注册。</p>
<p>这之后 Laravel 会将服务提供者标记为已经注册的状态，随后会调用服务提供者定义的 boot() 方法启动服务提供者（前提是应用已经启动）。</p>
<p>在向容器中注册绑定时，有 bind() 和 singleton() 两种方法，其区别仅在于注册的绑定是否为单例模式，即 shared 属性是否为 true 。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Container\Container</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">singleton</span>(<span class="params"><span class="variable">$abstract</span>, <span class="variable">$concrete</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">bind</span>(<span class="variable">$abstract</span>, <span class="variable">$concrete</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params"><span class="variable">$abstract</span>, <span class="variable">$concrete</span> = <span class="literal">null</span>, <span class="variable">$shared</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 删除旧的绑定</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">dropStaleInstances</span>(<span class="variable">$abstract</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$concrete</span>)) &#123;</span><br><span class="line">        <span class="variable">$concrete</span> = <span class="variable">$abstract</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="variable">$concrete</span> <span class="keyword">instanceof</span> <span class="built_in">Closure</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="title function_ invoke__">is_string</span>(<span class="variable">$concrete</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="built_in">self</span>::<span class="variable language_">class</span>.<span class="string">&#x27;::bind(): Argument #2 ($concrete) must be of type Closure|string|null&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$concrete</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getClosure</span>(<span class="variable">$abstract</span>, <span class="variable">$concrete</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;bindings[<span class="variable">$abstract</span>] = <span class="title function_ invoke__">compact</span>(<span class="string">&#x27;concrete&#x27;</span>, <span class="string">&#x27;shared&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resolved</span>(<span class="variable">$abstract</span>)) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">rebound</span>(<span class="variable">$abstract</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getClosure</span>(<span class="params"><span class="variable">$abstract</span>, <span class="variable">$concrete</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$container</span>, <span class="variable">$parameters</span> = []</span>) <span class="keyword">use</span> (<span class="params"><span class="variable">$abstract</span>, <span class="variable">$concrete</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$abstract</span> == <span class="variable">$concrete</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$container</span>-&gt;<span class="title function_ invoke__">build</span>(<span class="variable">$concrete</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$container</span>-&gt;<span class="title function_ invoke__">resolve</span>(</span><br><span class="line">            <span class="variable">$concrete</span>, <span class="variable">$parameters</span>, <span class="variable">$raiseEvents</span> = <span class="literal">false</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仍然以日志服务提供者为例，日志服务提供者在注册时以单例模式进行注册，并且 $concrete 参数为闭包。在绑定开始之前，Laravel 首先会删除旧的绑定。由于此时 $concrete 为闭包，所以 Laravel 并不会进行什么操作，只是将绑定信息存入 $bindings 属性当中。</p>
<h2 id="访问服务"><a href="#访问服务" class="headerlink" title="访问服务"></a>访问服务</h2><p>在服务提供者注册完成之后，我们可以用上文提到的类似访问数据库连接的方式那样访问服务。仍然以日志服务为例，我们可以通过 $app[‘log’] 的方式访问日志服务。另外，在 Laravel 中，我们还可以使用 facade 的方式访问服务，例如，我们可以调用 Illuminate\Support\Facades\Log::info() 来记录日志。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Support\Facades\Log</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Log</span> <span class="keyword">extends</span> <span class="title">Facade</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;log&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// namespace Illuminate\Support\Facades\Facade</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$instance</span> = <span class="built_in">static</span>::<span class="title function_ invoke__">getFacadeRoot</span>();</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$instance</span>-&gt;<span class="variable">$method</span>(...<span class="variable">$args</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeRoot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static</span>::<span class="title function_ invoke__">resolveFacadeInstance</span>(<span class="built_in">static</span>::<span class="title function_ invoke__">getFacadeAccessor</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveFacadeInstance</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="built_in">static</span>::<span class="variable">$resolvedInstance</span>[<span class="variable">$name</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static</span>::<span class="variable">$resolvedInstance</span>[<span class="variable">$name</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">static</span>::<span class="variable">$app</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static</span>::<span class="variable">$resolvedInstance</span>[<span class="variable">$name</span>] = <span class="built_in">static</span>::<span class="variable">$app</span>[<span class="variable">$name</span>];</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在通过静态调用的方式进行日志记录时，首先会访问 Facade 中的魔术方法 __callStatic() ，该方法的首先进行的就是解析出 facade 对应的服务实例，然后调用该服务实例下的方法来执行相应的功能。每个 facade 中都会定义一个 getFacadeAccessor() 方法，这个方法会返回一个 tag，在日志服务中，这个 tag 就是日志服务提供者的闭包在容器的 $bindings 属性中的 key。也就是说，通过 facade 方式最终得到的是 $app[‘log’]。</p>
<p>那么为什么可以通过关联数组的方式访问容器中注册的对象&#x2F;服务？Illuminate\Container\Container 实现了 ArrayAccess 并且定义了 OffsetGet() 方法，而 Illuminate\Foundation\Application 继承了 Container ，$app 为 Application 实例化的对象，所以通过关联数组的方式访问容器中注册的对象时会访问 Container 的 OffsetGet() 方法。在 OffsetGet() 方法中会调用 Container 的 make() 方法，而 make() 方法中又会调用 resolve() 方法。resolve() 方法最终会解析并返回相应的对象。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Container</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="variable">$key</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params"><span class="variable">$abstract</span>, <span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resolve</span>(<span class="variable">$abstract</span>, <span class="variable">$parameters</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params"><span class="variable">$abstract</span>, <span class="variable">$parameters</span> = [], <span class="variable">$raiseEvents</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;with[] = <span class="variable">$parameters</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$concrete</span>)) &#123;</span><br><span class="line">        <span class="variable">$concrete</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getConcrete</span>(<span class="variable">$abstract</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isBuildable</span>(<span class="variable">$concrete</span>, <span class="variable">$abstract</span>)) &#123;</span><br><span class="line">        <span class="variable">$object</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">build</span>(<span class="variable">$concrete</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$object</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="variable">$concrete</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;resolved[<span class="variable">$abstract</span>] = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_ invoke__">array_pop</span>(<span class="variable">$this</span>-&gt;with);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$object</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getConcrete</span>(<span class="params"><span class="variable">$abstract</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;bindings[<span class="variable">$abstract</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;bindings[<span class="variable">$abstract</span>][<span class="string">&#x27;concrete&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$abstract</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isBuildable</span>(<span class="params"><span class="variable">$concrete</span>, <span class="variable">$abstract</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$concrete</span> === <span class="variable">$abstract</span> || <span class="variable">$concrete</span> <span class="keyword">instanceof</span> <span class="built_in">Closure</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params"><span class="variable">$concrete</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$concrete</span> <span class="keyword">instanceof</span> <span class="built_in">Closure</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$concrete</span>(<span class="variable language_">$this</span>, <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getLastParameterOverride</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getLastParameterOverride</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;with) ? <span class="title function_ invoke__">end</span>(<span class="variable">$this</span>-&gt;with) : [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要说明，在通过 $app[‘log’] 的方式解析日志服务实例时，resolve() 方法中的 $concrete 解析得到的是一个闭包，导致 isBuildable() 方法返回结果为 true，所以 Laravel 会直接调用 build() 方法。而由于此时 $concrete 是一个闭包，所以在 build() 方法中会直接执行这个闭包函数，最终返回 LogManager 实例。</p>
<h2 id="额外"><a href="#额外" class="headerlink" title="额外"></a>额外</h2><p>这里一直以日志服务举例，那就顺手把LogManager过程说明一下：以我们平常使用Log::info() 或 Log:error()为例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//namespace Illuminate\Log\LogManager</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">info</span>(<span class="params"><span class="variable">$message</span>, <span class="keyword">array</span> <span class="variable">$context</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">driver</span>()-&gt;<span class="title function_ invoke__">info</span>(<span class="variable">$message</span>, <span class="variable">$context</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">error</span>(<span class="params"><span class="variable">$message</span>, <span class="keyword">array</span> <span class="variable">$context</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">driver</span>()-&gt;<span class="title function_ invoke__">error</span>(<span class="variable">$message</span>, <span class="variable">$context</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">driver</span>(<span class="params"><span class="variable">$driver</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$driver</span> ?? <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">getDefaultDriver</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;channels[<span class="variable">$name</span>] ?? <span class="title function_ invoke__">with</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">resolve</span>(<span class="variable">$name</span>), function (<span class="variable">$logger</span>) <span class="keyword">use</span> ($<span class="title">name</span>) &#123;</span><br><span class="line">            <span class="title">return</span> $<span class="title">this</span>-&gt;<span class="title">channels</span>[$<span class="title">name</span>] = $<span class="title">this</span>-&gt;<span class="title">tap</span>($<span class="title">name</span>, <span class="title">new</span> <span class="title">Logger</span>($<span class="title">logger</span>, $<span class="title">this</span>-&gt;<span class="title">app</span>[&#x27;<span class="title">events</span>&#x27;]));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">tap</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">createEmergencyLogger</span>(), function (<span class="variable">$logger</span>) <span class="keyword">use</span> ($<span class="title">e</span>) &#123;</span><br><span class="line">            $<span class="title">logger</span>-&gt;<span class="title">emergency</span>(&#x27;<span class="title">Unable</span> <span class="title">to</span> <span class="title">create</span> <span class="title">configured</span> <span class="title">logger</span>. <span class="title">Using</span> <span class="title">emergency</span> <span class="title">logger</span>.&#x27;, [</span><br><span class="line">                &#x27;<span class="title">exception</span>&#x27; =&gt; $<span class="title">e</span>,</span><br><span class="line">            ]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$config</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">configurationFor</span>(<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$config</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">InvalidArgumentException</span>(<span class="string">&quot;Log [<span class="subst">&#123;$name&#125;</span>] is not defined.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;customCreators[<span class="variable">$config</span>[<span class="string">&#x27;driver&#x27;</span>]])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">callCustomCreator</span>(<span class="variable">$config</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$driverMethod</span> = <span class="string">&#x27;create&#x27;</span>.<span class="title function_ invoke__">ucfirst</span>(<span class="variable">$config</span>[<span class="string">&#x27;driver&#x27;</span>]).<span class="string">&#x27;Driver&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>, <span class="variable">$driverMethod</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;&#123;<span class="variable">$driverMethod</span>&#125;(<span class="variable">$config</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">InvalidArgumentException</span>(<span class="string">&quot;Driver [<span class="subst">&#123;$config[&#x27;driver&#x27;]&#125;</span>] is not supported.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里其实就是要去执行$driverMethod &#x3D; ‘create’.ucfirst($config[‘driver’]).’Driver’; 方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createStackDriver</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$config</span>[<span class="string">&#x27;channels&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$config</span>[<span class="string">&#x27;channels&#x27;</span>] = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$config</span>[<span class="string">&#x27;channels&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$handlers</span> = <span class="title function_ invoke__">collect</span>(<span class="variable">$config</span>[<span class="string">&#x27;channels&#x27;</span>])-&gt;<span class="title function_ invoke__">flatMap</span>(function (<span class="variable">$channel</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">channel</span>(<span class="variable">$channel</span>)-&gt;<span class="title function_ invoke__">getHandlers</span>();</span><br><span class="line">    &#125;)-&gt;<span class="title function_ invoke__">all</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$processors</span> = <span class="title function_ invoke__">collect</span>(<span class="variable">$config</span>[<span class="string">&#x27;channels&#x27;</span>])-&gt;<span class="title function_ invoke__">flatMap</span>(function (<span class="variable">$channel</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">channel</span>(<span class="variable">$channel</span>)-&gt;<span class="title function_ invoke__">getProcessors</span>();</span><br><span class="line">    &#125;)-&gt;<span class="title function_ invoke__">all</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$config</span>[<span class="string">&#x27;ignore_exceptions&#x27;</span>] ?? <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="variable">$handlers</span> = [<span class="keyword">new</span> <span class="title class_">WhatFailureGroupHandler</span>(<span class="variable">$handlers</span>)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Monolog</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseChannel</span>(<span class="variable">$config</span>), <span class="variable">$handlers</span>, <span class="variable">$processors</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createSingleDriver</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Monolog</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseChannel</span>(<span class="variable">$config</span>), [</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">prepareHandler</span>(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">StreamHandler</span>(</span><br><span class="line">                <span class="variable">$config</span>[<span class="string">&#x27;path&#x27;</span>], <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">level</span>(<span class="variable">$config</span>),</span><br><span class="line">                <span class="variable">$config</span>[<span class="string">&#x27;bubble&#x27;</span>] ?? <span class="literal">true</span>, <span class="variable">$config</span>[<span class="string">&#x27;permission&#x27;</span>] ?? <span class="literal">null</span>, <span class="variable">$config</span>[<span class="string">&#x27;locking&#x27;</span>] ?? <span class="literal">false</span></span><br><span class="line">            ), <span class="variable">$config</span></span><br><span class="line">        ),</span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createDailyDriver</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Monolog</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseChannel</span>(<span class="variable">$config</span>), [</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">prepareHandler</span>(<span class="keyword">new</span> <span class="title class_">RotatingFileHandler</span>(</span><br><span class="line">            <span class="variable">$config</span>[<span class="string">&#x27;path&#x27;</span>], <span class="variable">$config</span>[<span class="string">&#x27;days&#x27;</span>] ?? <span class="number">7</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">level</span>(<span class="variable">$config</span>),</span><br><span class="line">            <span class="variable">$config</span>[<span class="string">&#x27;bubble&#x27;</span>] ?? <span class="literal">true</span>, <span class="variable">$config</span>[<span class="string">&#x27;permission&#x27;</span>] ?? <span class="literal">null</span>, <span class="variable">$config</span>[<span class="string">&#x27;locking&#x27;</span>] ?? <span class="literal">false</span></span><br><span class="line">        ), <span class="variable">$config</span>),</span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 一共有下面Log Channels的Available Drivers 8个 对应的8个方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//config/logging.php</span></span><br><span class="line"><span class="string">&#x27;default&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;LOG_CHANNEL&#x27;</span>, <span class="string">&#x27;stack&#x27;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    | Log Channels</span></span><br><span class="line"><span class="comment">    |--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | Here you may configure the log channels for your application. Out of</span></span><br><span class="line"><span class="comment">    | the box, Laravel uses the Monolog PHP logging library. This gives</span></span><br><span class="line"><span class="comment">    | you a variety of powerful log handlers / formatters to utilize.</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    | Available Drivers: &quot;single&quot;, &quot;daily&quot;, &quot;slack&quot;, &quot;syslog&quot;,</span></span><br><span class="line"><span class="comment">    |                    &quot;errorlog&quot;, &quot;monolog&quot;,</span></span><br><span class="line"><span class="comment">    |                    &quot;custom&quot;, &quot;stack&quot;</span></span><br><span class="line"><span class="comment">    |</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;channels&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;stack&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;stack&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;channels&#x27;</span> =&gt; [<span class="string">&#x27;single&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;ignore_exceptions&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;single&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;single&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;path&#x27;</span> =&gt; <span class="title function_ invoke__">storage_path</span>(<span class="string">&#x27;logs/laravel.log&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;LOG_LEVEL&#x27;</span>, <span class="string">&#x27;debug&#x27;</span>),</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;daily&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;daily&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;path&#x27;</span> =&gt; <span class="title function_ invoke__">storage_path</span>(<span class="string">&#x27;logs/laravel.log&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;LOG_LEVEL&#x27;</span>, <span class="string">&#x27;debug&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;days&#x27;</span> =&gt; <span class="number">14</span>,</span><br><span class="line">            <span class="string">&#x27;permission&#x27;</span> =&gt; <span class="number">0777</span>,</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;slack&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;slack&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;url&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;LOG_SLACK_WEBHOOK_URL&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;Laravel Log&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;emoji&#x27;</span> =&gt; <span class="string">&#x27;:boom:&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;LOG_LEVEL&#x27;</span>, <span class="string">&#x27;critical&#x27;</span>),</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;papertrail&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;monolog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;LOG_LEVEL&#x27;</span>, <span class="string">&#x27;debug&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;handler&#x27;</span> =&gt; <span class="title class_">SyslogUdpHandler</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="string">&#x27;handler_with&#x27;</span> =&gt; [</span><br><span class="line">                <span class="string">&#x27;host&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;PAPERTRAIL_URL&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;port&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;PAPERTRAIL_PORT&#x27;</span>),</span><br><span class="line">            ],</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;stderr&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;monolog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;handler&#x27;</span> =&gt; <span class="title class_">StreamHandler</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;LOG_STDERR_FORMATTER&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;with&#x27;</span> =&gt; [</span><br><span class="line">                <span class="string">&#x27;stream&#x27;</span> =&gt; <span class="string">&#x27;php://stderr&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;syslog&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;syslog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;LOG_LEVEL&#x27;</span>, <span class="string">&#x27;debug&#x27;</span>),</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;errorlog&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;errorlog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;LOG_LEVEL&#x27;</span>, <span class="string">&#x27;debug&#x27;</span>),</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;null&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;monolog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;handler&#x27;</span> =&gt; <span class="title class_">NullHandler</span>::<span class="variable language_">class</span>,</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;emergency&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;path&#x27;</span> =&gt; <span class="title function_ invoke__">storage_path</span>(<span class="string">&#x27;logs/laravel.log&#x27;</span>),</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure>
<p>以daily的driver为例(配置文件中的default)，最后调用的就是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//namespace Monolog</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">info</span>(<span class="params"><span class="variable">$message</span>, <span class="keyword">array</span> <span class="variable">$context</span> = []</span>): <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">addRecord</span>(<span class="built_in">static</span>::<span class="variable constant_">INFO</span>, (<span class="keyword">string</span>) <span class="variable">$message</span>, <span class="variable">$context</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addRecord</span>(<span class="params"><span class="keyword">int</span> <span class="variable">$level</span>, <span class="keyword">string</span> <span class="variable">$message</span>, <span class="keyword">array</span> <span class="variable">$context</span> = []</span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$offset</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable">$record</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;handlers <span class="keyword">as</span> <span class="variable">$handler</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> === <span class="variable">$record</span>) &#123;</span><br><span class="line">            <span class="comment">// skip creating the record as long as no handler is going to handle it</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable">$handler</span>-&gt;<span class="title function_ invoke__">isHandling</span>([<span class="string">&#x27;level&#x27;</span> =&gt; <span class="variable">$level</span>])) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$levelName</span> = <span class="built_in">static</span>::<span class="title function_ invoke__">getLevelName</span>(<span class="variable">$level</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$record</span> = [</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span> =&gt; <span class="variable">$message</span>,</span><br><span class="line">                <span class="string">&#x27;context&#x27;</span> =&gt; <span class="variable">$context</span>,</span><br><span class="line">                <span class="string">&#x27;level&#x27;</span> =&gt; <span class="variable">$level</span>,</span><br><span class="line">                <span class="string">&#x27;level_name&#x27;</span> =&gt; <span class="variable">$levelName</span>,</span><br><span class="line">                <span class="string">&#x27;channel&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;name,</span><br><span class="line">                <span class="string">&#x27;datetime&#x27;</span> =&gt; <span class="keyword">new</span> <span class="title class_">DateTimeImmutable</span>(<span class="variable language_">$this</span>-&gt;microsecondTimestamps, <span class="variable language_">$this</span>-&gt;timezone),</span><br><span class="line">                <span class="string">&#x27;extra&#x27;</span> =&gt; [],</span><br><span class="line">            ];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;processors <span class="keyword">as</span> <span class="variable">$processor</span>) &#123;</span><br><span class="line">                    <span class="variable">$record</span> = <span class="variable">$processor</span>(<span class="variable">$record</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">handleException</span>(<span class="variable">$e</span>, <span class="variable">$record</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// once the record exists, send it to all handlers as long as the bubbling chain is not interrupted</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$handler</span>-&gt;<span class="title function_ invoke__">handle</span>(<span class="variable">$record</span>)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">handleException</span>(<span class="variable">$e</span>, <span class="variable">$record</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span> !== <span class="variable">$record</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果想使用不同的driver 可以使用logs方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logs</span>(<span class="params"><span class="variable">$driver</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$driver</span> ? <span class="title function_ invoke__">app</span>(<span class="string">&#x27;log&#x27;</span>)-&gt;<span class="title function_ invoke__">driver</span>(<span class="variable">$driver</span>) : <span class="title function_ invoke__">app</span>(<span class="string">&#x27;log&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="请求处理"><a href="#请求处理" class="headerlink" title="请求处理"></a>请求处理</h1><p>在基础的绑定和服务注册完成之后，容器创建成功并返回 $app 。之后 Laravel 会将内核（包括 Http 内核和 Console 内核）和异常处理注册到容器当中。然后 Laravel 开始处理请求。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace bootstrap/app.php</span></span><br><span class="line"><span class="variable">$app</span>-&gt;<span class="title function_ invoke__">singleton</span>(</span><br><span class="line">    <span class="title class_">Illuminate\Contracts\Http\Kernel</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">App\Http\Kernel</span>::<span class="variable language_">class</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span>-&gt;<span class="title function_ invoke__">singleton</span>(</span><br><span class="line">    <span class="title class_">Illuminate\Contracts\Console\Kernel</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">App\Console\Kernel</span>::<span class="variable language_">class</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span>-&gt;<span class="title function_ invoke__">singleton</span>(</span><br><span class="line">    <span class="title class_">Illuminate\Contracts\Debug\ExceptionHandler</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">App\Exceptions\Handler</span>::<span class="variable language_">class</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// public/index.php</span></span><br><span class="line"><span class="variable">$kernel</span> = <span class="variable">$app</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="title class_">Illuminate\Contracts\Http\Kernel</span>::<span class="variable language_">class</span>);</span><br><span class="line"><span class="variable">$response</span> = <span class="variable">$kernel</span>-&gt;<span class="title function_ invoke__">handle</span>(</span><br><span class="line">    <span class="variable">$request</span> = <span class="title class_">Request</span>::<span class="title function_ invoke__">capture</span>()</span><br><span class="line">)-&gt;<span class="title function_ invoke__">send</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$kernel</span>-&gt;<span class="title function_ invoke__">terminate</span>(<span class="variable">$request</span>, <span class="variable">$response</span>);</span><br></pre></td></tr></table></figure>
<p>在开始处理请求之前，Laravel 首先会解析出 Http 内核对象 $kernel，即 App\Http\Kernel 实例化的对象。而 App\Http\Kernel 继承了 Illuminate\Foundation\Kernel，所以 $kernel 实际调用的是 Illuminate\Foundation\Kernel 中的 handle() 方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>\<span class="title class_">Http</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">use</span> <span class="title class_">Illuminate</span>\<span class="title class_">Contracts</span>\<span class="title class_">Debug</span>\<span class="title class_">ExceptionHandler</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">public</span> <span class="title class_">function</span> <span class="title class_">handle</span>($<span class="title class_">request</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title class_">try</span> &#123;</span><br><span class="line">        $<span class="title class_">request</span>-&gt;<span class="title class_">enableHttpMethodParameterOverride</span>();</span><br><span class="line">        <span class="variable">$response</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendRequestThroughRouter</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">reportException</span>(<span class="variable">$e</span>);</span><br><span class="line">        <span class="variable">$response</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">renderException</span>(<span class="variable">$request</span>, <span class="variable">$e</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;app[<span class="string">&#x27;events&#x27;</span>]-&gt;<span class="title function_ invoke__">dispatch</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RequestHandled</span>(<span class="variable">$request</span>, <span class="variable">$response</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上报错误</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">reportException</span>(<span class="params"><span class="built_in">Throwable</span> <span class="variable">$e</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;app[<span class="title class_">ExceptionHandler</span>::<span class="variable language_">class</span>]-&gt;<span class="title function_ invoke__">report</span>(<span class="variable">$e</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 渲染错误信息    </span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">renderException</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Throwable</span> <span class="variable">$e</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;app[<span class="title class_">ExceptionHandler</span>::<span class="variable language_">class</span>]-&gt;<span class="title function_ invoke__">render</span>(<span class="variable">$request</span>, <span class="variable">$e</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handle() 方法在处理请求的过程中如果出现任何异常或错误，Laravel 都会调用容器中已经注册好的异常处理对象来上报异常并且渲染返回信息。</p>
<p>在容器创建成功以后，Laravel 会将 Illuminate\Contracts\Debug\ExceptionHandler 和 App\Exceptions\Handler 之间的绑定注册到容器当中，所以 Laravel 处理异常实际调用的都是 App\Exceptions\Handler 中的方法。在实际开发过程中，开发者可以根据自身需要在 App\Exceptions\Handler 中自定义 report() 和 render() 方法。</p>
<p>在 PHP 7 中，<code>Exception</code> 和 <code>Error</code> 是两种不同的类型，但它们同时都继承了 <code>Throwable</code> ，所以 <code>handler()</code> 方法中捕获的是 <code>Throwable</code> 对象。</p>
<p>在正式开始处理请求之前，Laravel 会进行一些引导启动，包括加载环境变量、配置信息等，这些引导启动在 Laravel 运行过程中起到了非常重要的作用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Foundation\Http\Kernel</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$bootstrappers</span> = [</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\LoadConfiguration</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\HandleExceptions</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\RegisterFacades</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\RegisterProviders</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\BootProviders</span>::<span class="variable language_">class</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">bootstrap</span>();</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">hasBeenBootstrapped</span>()) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">bootstrapWith</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">bootstrappers</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// namespace Illuminate\Foundation\Application</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrapWith</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$bootstrappers</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;hasBeenBootstrapped = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$bootstrappers</span> <span class="keyword">as</span> <span class="variable">$bootstrapper</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>[<span class="string">&#x27;events&#x27;</span>]-&gt;<span class="title function_ invoke__">dispatch</span>(<span class="string">&#x27;bootstrapping: &#x27;</span>.<span class="variable">$bootstrapper</span>, [<span class="variable">$this</span>]);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="variable">$bootstrapper</span>)-&gt;<span class="title function_ invoke__">bootstrap</span>(<span class="variable">$this</span>);</span><br><span class="line">        <span class="variable language_">$this</span>[<span class="string">&#x27;events&#x27;</span>]-&gt;<span class="title function_ invoke__">dispatch</span>(<span class="string">&#x27;bootstrapped: &#x27;</span>.<span class="variable">$bootstrapper</span>, [<span class="variable">$this</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码中可以看出，引导启动的过程实际就是调用各个 class 中的 bootstrap() 方法。其中：</p>
<p>LoadEnvironmentVariables 用来加载环境变量</p>
<p>LoadConfiguration 用来加载 config 目录下的配置文件</p>
<p>HandleExceptions 用来设置 PHP 的错误报告级别以及相应的异常和错误处理函数，另外还会设置 PHP 的程序终止执行函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Foundation\Bootstrap\HandleExceptions</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params">Application <span class="variable">$app</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;app = <span class="variable">$app</span>;</span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(-<span class="number">1</span>);</span><br><span class="line">    <span class="title function_ invoke__">set_error_handler</span>([<span class="variable">$this</span>, <span class="string">&#x27;handleError&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">set_exception_handler</span>([<span class="variable">$this</span>, <span class="string">&#x27;handleException&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">register_shutdown_function</span>([<span class="variable">$this</span>, <span class="string">&#x27;handleShutdown&#x27;</span>]);</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params"><span class="variable">$level</span>, <span class="variable">$message</span>, <span class="variable">$file</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$line</span> = <span class="number">0</span>, <span class="variable">$context</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">error_reporting</span>() &amp; <span class="variable">$level</span>) &#123;</span><br><span class="line">        <span class="comment">/* ... ... */</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">ErrorException</span>(<span class="variable">$message</span>, <span class="number">0</span>, <span class="variable">$level</span>, <span class="variable">$file</span>, <span class="variable">$line</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleException</span>(<span class="params"><span class="built_in">Throwable</span> <span class="variable">$e</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getExceptionHandler</span>()-&gt;<span class="title function_ invoke__">report</span>(<span class="variable">$e</span>);</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleShutdown</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="title function_ invoke__">is_null</span>(<span class="variable">$error</span> = <span class="title function_ invoke__">error_get_last</span>()) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isFatal</span>(<span class="variable">$error</span>[<span class="string">&#x27;type&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">handleException</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">fatalErrorFromPhpError</span>(<span class="variable">$error</span>, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getExceptionHandler</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">make</span>(<span class="title class_">\Illuminate\Contracts\Debug\ExceptionHandler</span>::<span class="variable language_">class</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上代码中可以看出，虽然 HandleExceptions 中定义了异常、错误、程序终止的处理函数，但无论是哪种情况，最终还是调用 App\Exceptions\Handler 中的方法来处理异常或错误。</p>
<p>RegisterFacades 的作用一个是注册配置文件以及第三方包中自定义的 alias 类，还有一个非常重要的作用就是为 Illuminate\Support\Facades\Facade 类设置 $app 属性。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Foundation\Bootstrap\RegisterFAcades</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params">Application <span class="variable">$app</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="title class_">Facade</span>::<span class="title function_ invoke__">clearResolvedInstances</span>();</span><br><span class="line">    <span class="title class_">Facade</span>::<span class="title function_ invoke__">setFacadeApplication</span>(<span class="variable">$app</span>);</span><br><span class="line">    <span class="title class_">AliasLoader</span>::<span class="title function_ invoke__">getInstance</span>(<span class="title function_ invoke__">array_merge</span>(</span><br><span class="line">        <span class="variable">$app</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="string">&#x27;config&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;app.aliases&#x27;</span>, []),</span><br><span class="line">        <span class="variable">$app</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="title class_">PackageManifest</span>::<span class="variable language_">class</span>)-&gt;<span class="title function_ invoke__">aliases</span>()</span><br><span class="line">    ))-&gt;<span class="title function_ invoke__">register</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在通过 facade 方式反问容器中注册的服务时，Facade 在解析容器中的服务实例时用到的 static::$app 即是在这个时候设置的。</p>
<p>RegisterProviders 的作用是注册配置文件以及第三方包中定义的服务提供者</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Foundation\Bootstrap\RegisterProviders</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params">Application <span class="variable">$app</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$app</span>-&gt;<span class="title function_ invoke__">registerConfiguredProviders</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerConfiguredProviders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$providers</span> = <span class="title class_">Collection</span>::<span class="title function_ invoke__">make</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="string">&#x27;config&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;app.providers&#x27;</span>))</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">partition</span>(function (<span class="variable">$provider</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="title function_ invoke__">strpos</span>(<span class="variable">$provider</span>, <span class="string">&#x27;Illuminate\\&#x27;</span>) === <span class="number">0</span>;</span><br><span class="line">                    &#125;);</span><br><span class="line">    <span class="variable">$providers</span>-&gt;<span class="title function_ invoke__">splice</span>(<span class="number">1</span>, <span class="number">0</span>, [<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="title class_">PackageManifest</span>::<span class="variable language_">class</span>)-&gt;<span class="title function_ invoke__">providers</span>()]);</span><br><span class="line">    (<span class="keyword">new</span> <span class="title class_">ProviderRepository</span>(<span class="variable language_">$this</span>, <span class="keyword">new</span> <span class="title class_">Filesystem</span>, <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCachedServicesPath</span>()))</span><br><span class="line">                -&gt;<span class="title function_ invoke__">load</span>(<span class="variable">$providers</span>-&gt;<span class="title function_ invoke__">collapse</span>()-&gt;<span class="title function_ invoke__">toArray</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在实际注册的过程中，Laravel 会按照 Laravel 框架的服务提供者 &gt; 第三方包的服务提供者 &gt; 开发者自定义的服务提供者 的顺序进行注册</p>
<p>BootProviders 则是按顺序调用已经注册到容器中的服务提供者的 boot() 方法（前提是服务提供者定义的 boot() 方法）</p>
<p>在引导启动完成之后，Laravel 开始处理请求，首先要做的就是将全局的中间件应用于 request 。这之后 Laravel 会将请求分发到相应的路由进行处理，处理之前需要先根据 request 找到相应的路由对象 Illuminate\Routing\Route。在 Laravel 中，除了全局中间件，还有一些中间件只作用于特定的路由或路由分组，此时这些中间件就会被作用于 request 。这些工作都完成之后，路由对象开始执行代码，完成请求。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Foundation\Http\Kernel</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">Pipeline</span>(<span class="variable language_">$this</span>-&gt;app))</span><br><span class="line">                -&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$request</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">through</span>(<span class="variable">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">shouldSkipMiddleware</span>() ? [] : <span class="variable">$this</span>-&gt;middleware)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">then</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">dispatchToRouter</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$request</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;request&#x27;</span>, <span class="variable">$request</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;router-&gt;<span class="title function_ invoke__">dispatch</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// namespace Illuminate\Routing\Router</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;currentRequest = <span class="variable">$request</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">dispatchToRoute</span>(<span class="variable">$request</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRoute</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">runRoute</span>(<span class="variable">$request</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">findRoute</span>(<span class="variable">$request</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRoute</span>(<span class="params">Request <span class="variable">$request</span>, Route <span class="variable">$route</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">prepareResponse</span>(<span class="variable">$request</span>,</span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">runRouteWithinStack</span>(<span class="variable">$route</span>, <span class="variable">$request</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRouteWithinStack</span>(<span class="params">Route <span class="variable">$route</span>, Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span>   </span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">Pipeline</span>(<span class="variable language_">$this</span>-&gt;container))</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$request</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">through</span>(<span class="variable">$middleware</span>)</span><br><span class="line">                    -&gt;<span class="title function_ invoke__">then</span>(function (<span class="variable">$request</span>) <span class="keyword">use</span> ($<span class="title">route</span>) &#123;</span><br><span class="line">                        <span class="title">return</span> $<span class="title">this</span>-&gt;<span class="title">prepareResponse</span>(</span><br><span class="line">                            $<span class="title">request</span>, $<span class="title">route</span>-&gt;<span class="title">run</span>()</span><br><span class="line">                        );</span><br><span class="line">                    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h1><p>Laravel 中的路由在注册时，action 可以是控制器方法，也可以是闭包。但无论是那种形式，都需要传参，而传参就会遇到需要依赖注入的情况。</p>
<p>Route 对象在执行 run() 方法时会根据 action 的类型分别进行控制器方法调用或闭包函数的调用。但两种方法最终都需要解析参数，而如果参数中用到了 class ，就需要进行依赖注入。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Routing\Router</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;container = <span class="variable language_">$this</span>-&gt;container ?: <span class="keyword">new</span> <span class="title class_">Container</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isControllerAction</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">runController</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">runCallable</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (HttpResponseException <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getResponse</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runController</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">controllerDispatcher</span>()-&gt;<span class="title function_ invoke__">dispatch</span>(</span><br><span class="line">        <span class="variable">$this</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">getController</span>(), <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">getControllerMethod</span>()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runCallable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$callable</span>(...<span class="title function_ invoke__">array_values</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">resolveMethodDependencies</span>(</span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parametersWithoutNulls</span>(), <span class="keyword">new</span> <span class="title class_">ReflectionFunction</span>(<span class="variable">$callable</span>)</span><br><span class="line">    )));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// namespace Illuminate\Routing\ControllerDispatcher</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">Route <span class="variable">$route</span>, <span class="variable">$controller</span>, <span class="variable">$method</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$parameters</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resolveClassMethodDependencies</span>(</span><br><span class="line">        <span class="variable">$route</span>-&gt;<span class="title function_ invoke__">parametersWithoutNulls</span>(), <span class="variable">$controller</span>, <span class="variable">$method</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// namespace Illuminate\Routing\RouteDependencyResolverTrait</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveClassMethodDependencies</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span>, <span class="variable">$instance</span>, <span class="variable">$method</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resolveMethodDependencies</span>(</span><br><span class="line">        <span class="variable">$parameters</span>, <span class="keyword">new</span> <span class="title class_">ReflectionMethod</span>(<span class="variable">$instance</span>, <span class="variable">$method</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveMethodDependencies</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span>, ReflectionFunctionAbstract <span class="variable">$reflector</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$reflector</span>-&gt;<span class="title function_ invoke__">getParameters</span>() <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$parameter</span>) &#123;</span><br><span class="line">        <span class="variable">$instance</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">transformDependency</span>(<span class="variable">$parameter</span>, <span class="variable">$parameters</span>, <span class="variable">$skippableValue</span>);</span><br><span class="line">        <span class="comment">/* ... ... */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$parameters</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">transformDependency</span>(<span class="params">ReflectionParameter <span class="variable">$parameter</span>, <span class="variable">$parameters</span>, <span class="variable">$skippableValue</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$className</span> = <span class="title class_">Reflector</span>::<span class="title function_ invoke__">getParameterClassName</span>(<span class="variable">$parameter</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$className</span> &amp;&amp; ! <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">alreadyInParameters</span>(<span class="variable">$className</span>, <span class="variable">$parameters</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$parameter</span>-&gt;<span class="title function_ invoke__">isDefaultValueAvailable</span>() ? <span class="literal">null</span> : <span class="variable language_">$this</span>-&gt;container-&gt;<span class="title function_ invoke__">make</span>(<span class="variable">$className</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$skippableValue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在执行过程中，Laravel 首先通过反射取得参数列表（对于控制器方法，使用 ReflectionMethod ，对于闭包函数，则使用 ReflectionFunction ）。在得到参数列表后，Laravel 仍然是利用反射，逐个判断参数类型。如果参数类型为 PHP 的内置类型，那么不需要什么特殊处理；但如果参数不是 PHP 内置类型，则需要利用反射解析出参数的具体类型。在解析出参数的具体类型之后，紧接着会判断该类型的对象是不是已经存在于参数列表中，如果不存在并且该类型也没有设置默认值，那么就需要通过容器创建出该类型的实例。</p>
<p>要通过容器创建指定 class 的实例，仍然需要用到 resolve() 方法。前文已经叙述过使用 resolve() 方法解析闭包函数的情况，所以这里值叙述实例化 class 的情况。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namespace Illuminate\Container\Container</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params"><span class="variable">$concrete</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... ... */</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$reflector</span> = <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="variable">$concrete</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ReflectionException <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingResolutionException</span>(<span class="string">&quot;Target class [<span class="subst">$concrete</span>] does not exist.&quot;</span>, <span class="number">0</span>, <span class="variable">$e</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="variable">$reflector</span>-&gt;<span class="title function_ invoke__">isInstantiable</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">notInstantiable</span>(<span class="variable">$concrete</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;buildStack[] = <span class="variable">$concrete</span>;</span><br><span class="line">    <span class="variable">$constructor</span> = <span class="variable">$reflector</span>-&gt;<span class="title function_ invoke__">getConstructor</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$constructor</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">array_pop</span>(<span class="variable">$this</span>-&gt;buildStack);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$concrete</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$dependencies</span> = <span class="variable">$constructor</span>-&gt;<span class="title function_ invoke__">getParameters</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$instances</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resolveDependencies</span>(<span class="variable">$dependencies</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BindingResolutionException <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">array_pop</span>(<span class="variable">$this</span>-&gt;buildStack);</span><br><span class="line">        <span class="keyword">throw</span> <span class="variable">$e</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">array_pop</span>(<span class="variable">$this</span>-&gt;buildStack);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$reflector</span>-&gt;<span class="title function_ invoke__">newInstanceArgs</span>(<span class="variable">$instances</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveDependencies</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$dependencies</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$results</span> = [];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$dependencies</span> <span class="keyword">as</span> <span class="variable">$dependency</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasParameterOverride</span>(<span class="variable">$dependency</span>)) &#123;</span><br><span class="line">            <span class="variable">$results</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getParameterOverride</span>(<span class="variable">$dependency</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">is_null</span>(<span class="title class_">Util</span>::<span class="title function_ invoke__">getParameterClassName</span>(<span class="variable">$dependency</span>))</span><br><span class="line">                        ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resolvePrimitive</span>(<span class="variable">$dependency</span>)</span><br><span class="line">                        : <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">resolveClass</span>(<span class="variable">$dependency</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$dependency</span>-&gt;<span class="title function_ invoke__">isVariadic</span>()) &#123;</span><br><span class="line">            <span class="variable">$results</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$results</span>, <span class="variable">$result</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$results</span>[] = <span class="variable">$result</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$results</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>容器在实例化 class 的时候，仍然是通过反射获取 class 基本信息。对于一些无法进行实例化的 class （例如 interface 、abstract class ），Laravel 会抛出异常；否则 Laravel 会继续获取 class 的构造函数的信息。对于不存在构造函数的 class ，意味着这些 class 在实例化的时候不需要额外的依赖，可以直接通过 new 来实例化；否则仍然是通过反射解析出构造函数的参数列表信息，然后逐个实例化这些参数列表中用到的 class 。在这些参数列表中的 class 都实例化完成之后，通过容器创建 class 的准备工作也已经完成，此时容器可以顺利创建出指定 class 的实例，然后注入到控制器方法或闭包中。</p>

  </article>
</div>


    




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <div class="clearfix">
    <a href="https://b3296.github.io" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2019 Bxl</li>
      <li><a href="https://b3296.github.io">Home</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a target="_blank" rel="noopener" href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a target="_blank" rel="noopener" href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
    </div>
    
  </footer>
</div>




<script src="/js/main.js"></script>

</body>
</html>
