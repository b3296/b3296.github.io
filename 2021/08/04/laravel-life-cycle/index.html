<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    Laravel 生命周期 | Hexo
  </title>
  <meta name="description" content="">
  
  <meta name="keywords" content="
  Laravel
  ">
  
  <meta name="author" content="Bxl">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="theme-color" content="#1e2327">
  <link rel="apple-touch-icon" href="https://github.githubassets.com/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://github.githubassets.com/apple-touch-icon-180x180.png">

  <link rel="icon" type="image/x-icon" href="https://github.githubassets.com/favicon.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  

  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
<meta name="generator" content="Hexo 6.2.0"></head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/archives">Archives</a></li>
        
        
        <li><a href="/categories">Categories</a></li>
        
        
        <li><a href="/tags">Tags</a></li>
        
        
        <li class="desktop-only"><a href="/atom.xml" target="_blank">RSS</a></li>
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="https://octodex.github.com/images/baracktocat.jpg"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/archives"
           class="header-toolbar-right"> 6 </a>
      </li>
      <li>
        <a href="/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/tags"
           class="header-toolbar-right"> 4 </a>
      </li>
      <li>
        <a href="/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/categories"
           class="header-toolbar-right"> 3 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/">Hexo</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    Bxl

    <span class="post-date float-right" title="{{moment(1628059957000).format('MMM DD, YYYY, h:mm:ss A')}}">
      
          <i class="fa fa-pencil-square-o"></i>
      
      {{moment(1628059957000).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>Laravel 生命周期</h1>
    <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Laravel 生命周期是一个值得研究和学习的主题，这篇文章就用来记录一下我研究Laravel 生命周期的过程（其中有些文字是借鉴其他博主的，但是所有文件过程都是我自己在项目中走完的）</p>
<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>Laravel 生命周期（或者说请求生命周期）概括起来主要分为 3 个主要阶段：</p>
<p>加载项目依赖<br>创建 Laravel 应用实例<br>接收请求并响应<br>而这 3 个阶段的处理都发生在入口文件 public&#x2F;index.php 文件内（public&#x2F;index.php 是一个新安装的 Laravel 项目默认入口文件）。</p>
<p>然而 index.php 文件仅包含极少的代码，但却出色的完成了一个 HTTP 请求从接收到响应的全部过程，逻辑组织的几近完美。</p>
<p>我们来看下入口文件实现的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Http</span>\<span class="title">Kernel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//准备阶段</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;LARAVEL_START&#x27;</span>, <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../storage/framework/maintenance.php&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">&#x27;/../storage/framework/maintenance.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 阶段一</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//阶段二</span></span><br><span class="line"><span class="variable">$app</span> = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">&#x27;/../bootstrap/app.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//阶段三</span></span><br><span class="line"><span class="variable">$kernel</span> = <span class="variable">$app</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="title class_">Kernel</span>::<span class="variable language_">class</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$response</span> = <span class="title function_ invoke__">tap</span>(<span class="variable">$kernel</span>-&gt;<span class="title function_ invoke__">handle</span>(</span><br><span class="line">    <span class="variable">$request</span> = <span class="title class_">Request</span>::<span class="title function_ invoke__">capture</span>()</span><br><span class="line">))-&gt;<span class="title function_ invoke__">send</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//结束</span></span><br><span class="line"><span class="variable">$kernel</span>-&gt;<span class="title function_ invoke__">terminate</span>(<span class="variable">$request</span>, <span class="variable">$response</span>);</span><br></pre></td></tr></table></figure>

<h1 id="生命周期之始末"><a href="#生命周期之始末" class="headerlink" title="生命周期之始末"></a>生命周期之始末</h1><h2 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h2><p>这里其实是可以没有的，就是记录开始时间，然后判断是否是维护中，如果存在维护文件的话，加载之后通常就会在维护文件中结束了。</p>
<h2 id="阶段一-加载项目依赖"><a href="#阶段一-加载项目依赖" class="headerlink" title="阶段一 加载项目依赖"></a>阶段一 加载项目依赖</h2><p>现代 PHP 依赖于 Composer 包管理器，入口文件通过引入由 Composer 包管理器自动生成的类加载程序，可以轻松注册并加载项目所依赖的第三方组件库。</p>
<p>所有组件的加载工作，仅需一行代码即可完成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="阶段二-创建-Laravel-应用实例"><a href="#阶段二-创建-Laravel-应用实例" class="headerlink" title="阶段二 创建 Laravel 应用实例"></a>阶段二 创建 Laravel 应用实例</h2><p>创建应用实例（或称服务容器），由位于 bootstrap&#x2F;app.php 文件里的引导程序完成，创建服务容器的过程即为应用初始化的过程，项目初始化时将完成包括：注册项目基础服务、注册项目服务提供者别名、注册目录路径等在内的一些列注册工作。</p>
<p>下面是 bootstrap&#x2F;app.php 的代码，包含两个主要部分「创建应用实例」和「绑定内核至 APP 服务容器」：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Create The Application</span></span><br><span class="line"><span class="variable">$app</span> = <span class="keyword">new</span> <span class="title class_">Illuminate\Foundation\Application</span>(</span><br><span class="line">    <span class="variable">$_ENV</span>[<span class="string">&#x27;APP_BASE_PATH&#x27;</span>] ?? <span class="title function_ invoke__">dirname</span>(<span class="keyword">__DIR__</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bind Important Interfaces</span></span><br><span class="line"><span class="variable">$app</span>-&gt;<span class="title function_ invoke__">singleton</span>(</span><br><span class="line">    <span class="title class_">Illuminate\Contracts\Http\Kernel</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">App\Http\Kernel</span>::<span class="variable language_">class</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span>-&gt;<span class="title function_ invoke__">singleton</span>(</span><br><span class="line">    <span class="title class_">Illuminate\Contracts\Console\Kernel</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">App\Console\Kernel</span>::<span class="variable language_">class</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span>-&gt;<span class="title function_ invoke__">singleton</span>(</span><br><span class="line">    <span class="title class_">Illuminate\Contracts\Debug\ExceptionHandler</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">App\Exceptions\Handler</span>::<span class="variable language_">class</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$app</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="创建应用实例"><a href="#创建应用实例" class="headerlink" title="创建应用实例"></a>创建应用实例</h3><p>创建应用实例即实例化 Illuminate\Foundation\Application 这个服务容器，<br>后续我们称其为 APP 容器。<br>在创建 APP 容器主要会完成：注册应用的基础路径并将路径绑定到 APP 容器 、<br>注册基础服务提供者至 APP 容器 、<br>注册核心容器别名至 APP 容器 等基础服务的注册工作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$basePath</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$basePath</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setBasePath</span>(<span class="variable">$basePath</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerBaseBindings</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerBaseServiceProviders</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerCoreContainerAliases</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setBasePath</span>(<span class="params"><span class="variable">$basePath</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;basePath = <span class="title function_ invoke__">rtrim</span>(<span class="variable">$basePath</span>, <span class="string">&#x27;\/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">bindPathsInContainer</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bindPathsInContainer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;path&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">path</span>());</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;path.base&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">basePath</span>());</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;path.lang&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">langPath</span>());</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;path.config&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">configPath</span>());</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;path.public&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">publicPath</span>());</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;path.storage&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">storagePath</span>());</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;path.database&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">databasePath</span>());</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;path.resources&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">resourcePath</span>());</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;path.bootstrap&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">bootstrapPath</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseBindings</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static</span>::<span class="title function_ invoke__">setInstance</span>(<span class="variable">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;app&#x27;</span>, <span class="variable">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="title class_">Container</span>::<span class="variable language_">class</span>, <span class="variable">$this</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">singleton</span>(<span class="title class_">Mix</span>::<span class="variable language_">class</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">singleton</span>(<span class="title class_">PackageManifest</span>::<span class="variable language_">class</span>, function () &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PackageManifest</span>(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Filesystem</span>, <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">basePath</span>(), <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCachedPackagesPath</span>()</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseServiceProviders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">register</span>(<span class="keyword">new</span> <span class="title class_">EventServiceProvider</span>(<span class="variable">$this</span>));</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">register</span>(<span class="keyword">new</span> <span class="title class_">LogServiceProvider</span>(<span class="variable">$this</span>));</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">register</span>(<span class="keyword">new</span> <span class="title class_">RoutingServiceProvider</span>(<span class="variable">$this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerCoreContainerAliases</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ([</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>                  =&gt; [<span class="built_in">self</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Container\Container</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Foundation\Application</span>::<span class="variable language_">class</span>, <span class="title class_">\Psr\Container\ContainerInterface</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;auth&#x27;</span>                 =&gt; [<span class="title class_">\Illuminate\Auth\AuthManager</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Auth\Factory</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;auth.driver&#x27;</span>          =&gt; [<span class="title class_">\Illuminate\Contracts\Auth\Guard</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;blade.compiler&#x27;</span>       =&gt; [<span class="title class_">\Illuminate\View\Compilers\BladeCompiler</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;cache&#x27;</span>                =&gt; [<span class="title class_">\Illuminate\Cache\CacheManager</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Cache\Factory</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;cache.store&#x27;</span>          =&gt; [<span class="title class_">\Illuminate\Cache\Repository</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Cache\Repository</span>::<span class="variable language_">class</span>, <span class="title class_">\Psr\SimpleCache\CacheInterface</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;cache.psr6&#x27;</span>           =&gt; [<span class="title class_">\Symfony\Component\Cache\Adapter\Psr16Adapter</span>::<span class="variable language_">class</span>, <span class="title class_">\Symfony\Component\Cache\Adapter\AdapterInterface</span>::<span class="variable language_">class</span>, <span class="title class_">\Psr\Cache\CacheItemPoolInterface</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;config&#x27;</span>               =&gt; [<span class="title class_">\Illuminate\Config\Repository</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Config\Repository</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;cookie&#x27;</span>               =&gt; [<span class="title class_">\Illuminate\Cookie\CookieJar</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Cookie\Factory</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Cookie\QueueingFactory</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;db&#x27;</span>                   =&gt; [<span class="title class_">\Illuminate\Database\DatabaseManager</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Database\ConnectionResolverInterface</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;db.connection&#x27;</span>        =&gt; [<span class="title class_">\Illuminate\Database\Connection</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Database\ConnectionInterface</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;encrypter&#x27;</span>            =&gt; [<span class="title class_">\Illuminate\Encryption\Encrypter</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Encryption\Encrypter</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Encryption\StringEncrypter</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;events&#x27;</span>               =&gt; [<span class="title class_">\Illuminate\Events\Dispatcher</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Events\Dispatcher</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;files&#x27;</span>                =&gt; [<span class="title class_">\Illuminate\Filesystem\Filesystem</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;filesystem&#x27;</span>           =&gt; [<span class="title class_">\Illuminate\Filesystem\FilesystemManager</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Filesystem\Factory</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;filesystem.disk&#x27;</span>      =&gt; [<span class="title class_">\Illuminate\Contracts\Filesystem\Filesystem</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;filesystem.cloud&#x27;</span>     =&gt; [<span class="title class_">\Illuminate\Contracts\Filesystem\Cloud</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;hash&#x27;</span>                 =&gt; [<span class="title class_">\Illuminate\Hashing\HashManager</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;hash.driver&#x27;</span>          =&gt; [<span class="title class_">\Illuminate\Contracts\Hashing\Hasher</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;translator&#x27;</span>           =&gt; [<span class="title class_">\Illuminate\Translation\Translator</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Translation\Translator</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;log&#x27;</span>                  =&gt; [<span class="title class_">\Illuminate\Log\LogManager</span>::<span class="variable language_">class</span>, <span class="title class_">\Psr\Log\LoggerInterface</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;mail.manager&#x27;</span>         =&gt; [<span class="title class_">\Illuminate\Mail\MailManager</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Mail\Factory</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;mailer&#x27;</span>               =&gt; [<span class="title class_">\Illuminate\Mail\Mailer</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Mail\Mailer</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Mail\MailQueue</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;auth.password&#x27;</span>        =&gt; [<span class="title class_">\Illuminate\Auth\Passwords\PasswordBrokerManager</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Auth\PasswordBrokerFactory</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;auth.password.broker&#x27;</span> =&gt; [<span class="title class_">\Illuminate\Auth\Passwords\PasswordBroker</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Auth\PasswordBroker</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;queue&#x27;</span>                =&gt; [<span class="title class_">\Illuminate\Queue\QueueManager</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Queue\Factory</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Queue\Monitor</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;queue.connection&#x27;</span>     =&gt; [<span class="title class_">\Illuminate\Contracts\Queue\Queue</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;queue.failer&#x27;</span>         =&gt; [<span class="title class_">\Illuminate\Queue\Failed\FailedJobProviderInterface</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;redirect&#x27;</span>             =&gt; [<span class="title class_">\Illuminate\Routing\Redirector</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;redis&#x27;</span>                =&gt; [<span class="title class_">\Illuminate\Redis\RedisManager</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Redis\Factory</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;redis.connection&#x27;</span>     =&gt; [<span class="title class_">\Illuminate\Redis\Connections\Connection</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Redis\Connection</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;request&#x27;</span>              =&gt; [<span class="title class_">\Illuminate\Http\Request</span>::<span class="variable language_">class</span>, <span class="title class_">\Symfony\Component\HttpFoundation\Request</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;router&#x27;</span>               =&gt; [<span class="title class_">\Illuminate\Routing\Router</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Routing\Registrar</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Routing\BindingRegistrar</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;session&#x27;</span>              =&gt; [<span class="title class_">\Illuminate\Session\SessionManager</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;session.store&#x27;</span>        =&gt; [<span class="title class_">\Illuminate\Session\Store</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Session\Session</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;url&#x27;</span>                  =&gt; [<span class="title class_">\Illuminate\Routing\UrlGenerator</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Routing\UrlGenerator</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;validator&#x27;</span>            =&gt; [<span class="title class_">\Illuminate\Validation\Factory</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\Validation\Factory</span>::<span class="variable language_">class</span>],</span><br><span class="line">        <span class="string">&#x27;view&#x27;</span>                 =&gt; [<span class="title class_">\Illuminate\View\Factory</span>::<span class="variable language_">class</span>, <span class="title class_">\Illuminate\Contracts\View\Factory</span>::<span class="variable language_">class</span>],</span><br><span class="line">    ] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$aliases</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$aliases</span> <span class="keyword">as</span> <span class="variable">$alias</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">alias</span>(<span class="variable">$key</span>, <span class="variable">$alias</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="内核绑定"><a href="#内核绑定" class="headerlink" title="内核绑定"></a>内核绑定</h3><p>接着将关注的焦点转移到绑定内核部分。</p>
<p>Laravel 会依据 HTTP 请求的运行环境的不同，将请求发送至相应的内核： HTTP 内核 或 Console 内核。无论 HTTP 内核还是 Console 内核，它们的作用都是是接收一个 HTTP 请求，随后返回一个响应，就是这么简单。</p>
<p>这篇文章主要研究 HTTP 内核，HTTP 内核继承自 Illuminate\Foundation\Http\Kernel 类.</p>
<p>在 「HTTP 内核」 内它定义了 中间件相关数组；在 「Illuminate\Foundation\Http\Kernel」 类内部定义了属性名为 「bootstrappers」 的 引导程序 数组。</p>
<p>中间件 提供了一种方便的机制来过滤进入应用的 HTTP 请求。<br>「引导程序」 包括完成环境检测、配置加载、异常处理、Facades 注册、服务提供者注册、启动服务这六个引导程序。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$bootstrappers</span> = [</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\LoadConfiguration</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\HandleExceptions</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\RegisterFacades</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\RegisterProviders</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Bootstrap\BootProviders</span>::<span class="variable language_">class</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$middleware</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$middlewareGroups</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$routeMiddleware</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$middlewarePriority</span> = [</span><br><span class="line">    <span class="title class_">\Illuminate\Cookie\Middleware\EncryptCookies</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Session\Middleware\StartSession</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\View\Middleware\ShareErrorsFromSession</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Contracts\Auth\Middleware\AuthenticatesRequests</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Routing\Middleware\ThrottleRequests</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Session\Middleware\AuthenticateSession</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Routing\Middleware\SubstituteBindings</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Auth\Middleware\Authorize</span>::<span class="variable language_">class</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h3 id="注册异常处理"><a href="#注册异常处理" class="headerlink" title="注册异常处理"></a>注册异常处理</h3><p>项目的异常处理由 App\Exceptions\Handler::class 类完成，继承自Illuminate\Foundation\Exceptions类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Throwable</span> <span class="variable">$e</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$e</span>, <span class="string">&#x27;render&#x27;</span>) &amp;&amp; <span class="variable">$response</span> = <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="variable">$request</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Router</span>::<span class="title function_ invoke__">toResponse</span>(<span class="variable">$request</span>, <span class="variable">$response</span>);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="variable">$e</span> <span class="keyword">instanceof</span> Responsable) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">toResponse</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$e</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">prepareException</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">mapException</span>(<span class="variable">$e</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;renderCallbacks <span class="keyword">as</span> <span class="variable">$renderCallback</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_a</span>(<span class="variable">$e</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">firstClosureParameterType</span>(<span class="variable">$renderCallback</span>))) &#123;</span><br><span class="line">            <span class="variable">$response</span> = <span class="variable">$renderCallback</span>(<span class="variable">$e</span>, <span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (! <span class="title function_ invoke__">is_null</span>(<span class="variable">$response</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$e</span> <span class="keyword">instanceof</span> HttpResponseException) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getResponse</span>();</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="variable">$e</span> <span class="keyword">instanceof</span> AuthenticationException) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">unauthenticated</span>(<span class="variable">$request</span>, <span class="variable">$e</span>);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="variable">$e</span> <span class="keyword">instanceof</span> ValidationException) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">convertValidationExceptionToResponse</span>(<span class="variable">$e</span>, <span class="variable">$request</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">expectsJson</span>()</span><br><span class="line">                ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">prepareJsonResponse</span>(<span class="variable">$request</span>, <span class="variable">$e</span>)</span><br><span class="line">                : <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">prepareResponse</span>(<span class="variable">$request</span>, <span class="variable">$e</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="阶段三-接收请求并响应"><a href="#阶段三-接收请求并响应" class="headerlink" title="阶段三 接收请求并响应"></a>阶段三 接收请求并响应</h2><p>在完成创建 APP 容器后即进入了第三个阶段 「接收请求并响应」。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tap1 解析内核实例</span></span><br><span class="line"><span class="variable">$kernel</span> = <span class="variable">$app</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="title class_">Kernel</span>::<span class="variable language_">class</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//tap2 处理 HTTP 请求</span></span><br><span class="line"><span class="comment">//2.2处理请求</span></span><br><span class="line"><span class="variable">$response</span> = <span class="title function_ invoke__">tap</span>(<span class="variable">$kernel</span>-&gt;<span class="title function_ invoke__">handle</span>(</span><br><span class="line">     // <span class="number">2.1</span>创建请求实例</span><br><span class="line">    <span class="variable">$request</span> = <span class="title class_">Request</span>::<span class="title function_ invoke__">capture</span>()</span><br><span class="line">))</span><br><span class="line"><span class="comment">//tap3 发送响应</span></span><br><span class="line">-&gt;<span class="title function_ invoke__">send</span>();</span><br></pre></td></tr></table></figure>

<h3 id="解析内核实例"><a href="#解析内核实例" class="headerlink" title="解析内核实例"></a>解析内核实例</h3><p>在第二阶段我们已经将 HTTP 内核 和 Console 内核 绑定到了 APP 容器，使用时通过 APP 容器 的 make() 方法将内核解析出来，解析的过程就是内核实例化的过程。<br>内核实例化时它的内部究竟又做了哪些操作呢？</p>
<p>进一步挖掘 Illuminate\Foundation\Http\Kernel 内核的 __construct(Illuminate\Contracts\Foundation\Application $app, \Illuminate\Routing\Router $router) 构造方法，它接收 APP 容器 和 路由器 两个参数。</p>
<p>在实例化内核时，构造函数内将在 HTTP 内核定义的「中间件组」注册到 路由器，注册完后就可以在实际处理 HTTP 请求前调用这些「中间件」实现 过滤 请求的目的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">Application <span class="variable">$app</span>, Router <span class="variable">$router</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;app = <span class="variable">$app</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;router = <span class="variable">$router</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">syncMiddlewareToRouter</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">syncMiddlewareToRouter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;router-&gt;middlewarePriority = <span class="variable language_">$this</span>-&gt;middlewarePriority;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;middlewareGroups <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$middleware</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;router-&gt;<span class="title function_ invoke__">middlewareGroup</span>(<span class="variable">$key</span>, <span class="variable">$middleware</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;routeMiddleware <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$middleware</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;router-&gt;<span class="title function_ invoke__">aliasMiddleware</span>(<span class="variable">$key</span>, <span class="variable">$middleware</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">middlewareGroup</span>(<span class="params"><span class="variable">$name</span>, <span class="keyword">array</span> <span class="variable">$middleware</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;middlewareGroups[<span class="variable">$name</span>] = <span class="variable">$middleware</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">aliasMiddleware</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$class</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;middleware[<span class="variable">$name</span>] = <span class="variable">$class</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="处理-HTTP-请求"><a href="#处理-HTTP-请求" class="headerlink" title="处理 HTTP 请求"></a>处理 HTTP 请求</h3><p>之前的所有处理，基本都是围绕在配置变量、注册服务等运行环境的构建上，构建完成后才是真刀真枪的来处理一个「HTTP 请求」。</p>
<p>处理请求实际包含两个阶段：</p>
<ul>
<li>创建请求实例</li>
<li>处理请求</li>
</ul>
<h4 id="创建请求实例"><a href="#创建请求实例" class="headerlink" title="创建请求实例"></a>创建请求实例</h4><p>请求实例 Illuminate\Http\Request 的 capture() 方法内部通过 Symfony 实例创建一个 Laravel 请求实例。这样我们就可以获取到用户请求报文的相关信息了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">capture</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static</span>::<span class="title function_ invoke__">enableHttpMethodParameterOverride</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static</span>::<span class="title function_ invoke__">createFromBase</span>(<span class="title class_">SymfonyRequest</span>::<span class="title function_ invoke__">createFromGlobals</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createFromBase</span>(<span class="params">SymfonyRequest <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$newRequest</span> = (<span class="keyword">new</span> <span class="built_in">static</span>)-&gt;<span class="title function_ invoke__">duplicate</span>(</span><br><span class="line">        <span class="variable">$request</span>-&gt;query-&gt;<span class="title function_ invoke__">all</span>(), <span class="variable">$request</span>-&gt;request-&gt;<span class="title function_ invoke__">all</span>(), <span class="variable">$request</span>-&gt;attributes-&gt;<span class="title function_ invoke__">all</span>(),</span><br><span class="line">        <span class="variable">$request</span>-&gt;cookies-&gt;<span class="title function_ invoke__">all</span>(), <span class="variable">$request</span>-&gt;files-&gt;<span class="title function_ invoke__">all</span>(), <span class="variable">$request</span>-&gt;server-&gt;<span class="title function_ invoke__">all</span>()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable">$newRequest</span>-&gt;headers-&gt;<span class="title function_ invoke__">replace</span>(<span class="variable">$request</span>-&gt;headers-&gt;<span class="title function_ invoke__">all</span>());</span><br><span class="line"></span><br><span class="line">    <span class="variable">$newRequest</span>-&gt;content = <span class="variable">$request</span>-&gt;content;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$newRequest</span>-&gt;request = <span class="variable">$newRequest</span>-&gt;<span class="title function_ invoke__">getInputSource</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$newRequest</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createFromGlobals</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$request</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">createRequestFromFactory</span>(<span class="variable">$_GET</span>, <span class="variable">$_POST</span>, [], <span class="variable">$_COOKIE</span>, <span class="variable">$_FILES</span>, <span class="variable">$_SERVER</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_POST</span>) &#123;</span><br><span class="line">        <span class="variable">$request</span>-&gt;request = <span class="keyword">new</span> <span class="title class_">InputBag</span>(<span class="variable">$_POST</span>);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="number">0</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$request</span>-&gt;headers-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;CONTENT_TYPE&#x27;</span>), <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>)</span><br><span class="line">        &amp;&amp; \<span class="title function_ invoke__">in_array</span>(<span class="title function_ invoke__">strtoupper</span>(<span class="variable">$request</span>-&gt;server-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;REQUEST_METHOD&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>)), [<span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;PATCH&#x27;</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="title function_ invoke__">parse_str</span>(<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">getContent</span>(), <span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$request</span>-&gt;request = <span class="keyword">new</span> <span class="title class_">InputBag</span>(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$request</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">duplicate</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$query</span> = <span class="literal">null</span>, <span class="keyword">array</span> <span class="variable">$request</span> = <span class="literal">null</span>, <span class="keyword">array</span> <span class="variable">$attributes</span> = <span class="literal">null</span>, <span class="keyword">array</span> <span class="variable">$cookies</span> = <span class="literal">null</span>, <span class="keyword">array</span> <span class="variable">$files</span> = <span class="literal">null</span>, <span class="keyword">array</span> <span class="variable">$server</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$dup</span> = <span class="keyword">clone</span> <span class="variable language_">$this</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> !== <span class="variable">$query</span>) &#123;</span><br><span class="line">        <span class="variable">$dup</span>-&gt;query = <span class="keyword">new</span> <span class="title class_">InputBag</span>(<span class="variable">$query</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> !== <span class="variable">$request</span>) &#123;</span><br><span class="line">        <span class="variable">$dup</span>-&gt;request = <span class="keyword">new</span> <span class="title class_">ParameterBag</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> !== <span class="variable">$attributes</span>) &#123;</span><br><span class="line">        <span class="variable">$dup</span>-&gt;attributes = <span class="keyword">new</span> <span class="title class_">ParameterBag</span>(<span class="variable">$attributes</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> !== <span class="variable">$cookies</span>) &#123;</span><br><span class="line">        <span class="variable">$dup</span>-&gt;cookies = <span class="keyword">new</span> <span class="title class_">InputBag</span>(<span class="variable">$cookies</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> !== <span class="variable">$files</span>) &#123;</span><br><span class="line">        <span class="variable">$dup</span>-&gt;files = <span class="keyword">new</span> <span class="title class_">FileBag</span>(<span class="variable">$files</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> !== <span class="variable">$server</span>) &#123;</span><br><span class="line">        <span class="variable">$dup</span>-&gt;server = <span class="keyword">new</span> <span class="title class_">ServerBag</span>(<span class="variable">$server</span>);</span><br><span class="line">        <span class="variable">$dup</span>-&gt;headers = <span class="keyword">new</span> <span class="title class_">HeaderBag</span>(<span class="variable">$dup</span>-&gt;server-&gt;<span class="title function_ invoke__">getHeaders</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$dup</span>-&gt;languages = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$dup</span>-&gt;charsets = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$dup</span>-&gt;encodings = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$dup</span>-&gt;acceptableContentTypes = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$dup</span>-&gt;pathInfo = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$dup</span>-&gt;requestUri = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$dup</span>-&gt;baseUrl = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$dup</span>-&gt;basePath = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$dup</span>-&gt;method = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$dup</span>-&gt;format = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$dup</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;_format&#x27;</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;_format&#x27;</span>)) &#123;</span><br><span class="line">        <span class="variable">$dup</span>-&gt;attributes-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&#x27;_format&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;_format&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$dup</span>-&gt;<span class="title function_ invoke__">getRequestFormat</span>(<span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="variable">$dup</span>-&gt;<span class="title function_ invoke__">setRequestFormat</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">getRequestFormat</span>(<span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$dup</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="处理请求"><a href="#处理请求" class="headerlink" title="处理请求"></a>处理请求</h4><p>请求处理发生在 HTTP 内核 的 handle() 方法内。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">enableHttpMethodParameterOverride</span>();</span><br><span class="line">        <span class="variable">$response</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendRequestThroughRouter</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">reportException</span>(<span class="variable">$e</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$response</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">renderException</span>(<span class="variable">$request</span>, <span class="variable">$e</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;app[<span class="string">&#x27;events&#x27;</span>]-&gt;<span class="title function_ invoke__">dispatch</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RequestHandled</span>(<span class="variable">$request</span>, <span class="variable">$response</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handle() 方法接收一个 HTTP 请求，并最终生成一个 HTTP 响应。</p>
<p>继续深入到处理 HTTP 请求的方法 $this-&gt;sendRequestThroughRouter($request) 内部。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;request&#x27;</span>, <span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Facade</span>::<span class="title function_ invoke__">clearResolvedInstance</span>(<span class="string">&#x27;request&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">bootstrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">Pipeline</span>(<span class="variable language_">$this</span>-&gt;app))</span><br><span class="line">                -&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$request</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">through</span>(<span class="variable">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">shouldSkipMiddleware</span>() ? [] : <span class="variable">$this</span>-&gt;middleware)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">then</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">dispatchToRouter</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将发现这段代码没有一行废话，它完成了大量的逻辑处理：</p>
<ul>
<li>首先，将 $request 实例注册到 APP 容器 供后续使用；</li>
<li>之后，清除之前 $request 实例缓存；</li>
<li>然后，启动「引导程序」；</li>
<li>最后，发送请求至路由。</li>
</ul>
<p>记得在之前「内核绑定」章节，有介绍在「HTTP 内核」中有把「引导程序 (bootstrappers)」绑定到了 APP 容器，以及这些引导程序的具体功能。</p>
<p>但是没有聊如何调用这些「引导程序」。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">hasBeenBootstrapped</span>()) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">bootstrapWith</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">bootstrappers</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrappers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;bootstrappers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$bootstrappers</span> = [</span><br><span class="line">        <span class="title class_">\Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">\Illuminate\Foundation\Bootstrap\LoadConfiguration</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">\Illuminate\Foundation\Bootstrap\HandleExceptions</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">\Illuminate\Foundation\Bootstrap\RegisterFacades</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">\Illuminate\Foundation\Bootstrap\RegisterProviders</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">\Illuminate\Foundation\Bootstrap\BootProviders</span>::<span class="variable language_">class</span>,</span><br><span class="line">    ];</span><br></pre></td></tr></table></figure>
<p>最终还是要看 Illuminate\Foundation\Application 的 bootstrapWith() 方法究竟如何来启动这些引导程序的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrapWith</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$bootstrappers</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;hasBeenBootstrapped = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$bootstrappers</span> <span class="keyword">as</span> <span class="variable">$bootstrapper</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>[<span class="string">&#x27;events&#x27;</span>]-&gt;<span class="title function_ invoke__">dispatch</span>(<span class="string">&#x27;bootstrapping: &#x27;</span>.<span class="variable">$bootstrapper</span>, [<span class="variable">$this</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="variable">$bootstrapper</span>)-&gt;<span class="title function_ invoke__">bootstrap</span>(<span class="variable">$this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>[<span class="string">&#x27;events&#x27;</span>]-&gt;<span class="title function_ invoke__">dispatch</span>(<span class="string">&#x27;bootstrapped: &#x27;</span>.<span class="variable">$bootstrapper</span>, [<span class="variable">$this</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里看到在 APP 容器内，会先解析对应的「引导程序」（即实例化），随后调用「引导程序」的 bootstrap() 完成的「引导程序」的启动操作。</p>
<p>作为示例随便挑一个「引导程序」来看看其内部的启动原理。</p>
<p>这边选 Illuminate\Foundation\Bootstrap\LoadConfiguration::class，它的功能是加载配置文件。</p>
<p>前面讲解「创建 Laravel 应用实例」章节的时候有「注册应用的基础路径并将路径绑定到 APP 容器」。此时，LoadConfiguration 类就是将 config 目录下的所有配置文件读取到一个集合中，这样就可以项目里通过 config() 辅助函数获取配置数据。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>\<span class="title class_">Bootstrap</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Config</span>\<span class="title">Repository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Config</span>\<span class="title">Repository</span> <span class="keyword">as</span> <span class="title">RepositoryContract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Foundation</span>\<span class="title">Application</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">SplFileInfo</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Finder</span>\<span class="title">Finder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadConfiguration</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params">Application <span class="variable">$app</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$items</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$cached</span> = <span class="variable">$app</span>-&gt;<span class="title function_ invoke__">getCachedConfigPath</span>())) &#123;</span><br><span class="line">            <span class="variable">$items</span> = <span class="keyword">require</span> <span class="variable">$cached</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$loadedFromCache</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$app</span>-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;config&#x27;</span>, <span class="variable">$config</span> = <span class="keyword">new</span> <span class="title class_">Repository</span>(<span class="variable">$items</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$loadedFromCache</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">loadConfigurationFiles</span>(<span class="variable">$app</span>, <span class="variable">$config</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$app</span>-&gt;<span class="title function_ invoke__">detectEnvironment</span>(function () <span class="keyword">use</span> ($<span class="title">config</span>) &#123;</span><br><span class="line">            <span class="title">return</span> $<span class="title">config</span>-&gt;<span class="title">get</span>(&#x27;<span class="title">app</span>.<span class="title">env</span>&#x27;, &#x27;<span class="title">production</span>&#x27;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">date_default_timezone_set</span>(<span class="variable">$config</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;app.timezone&#x27;</span>, <span class="string">&#x27;UTC&#x27;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">mb_internal_encoding</span>(<span class="string">&#x27;UTF-8&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadConfigurationFiles</span>(<span class="params">Application <span class="variable">$app</span>, RepositoryContract <span class="variable">$repository</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$files</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getConfigurationFiles</span>(<span class="variable">$app</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$files</span>[<span class="string">&#x27;app&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Unable to load the &quot;app&quot; configuration file.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$path</span>) &#123;</span><br><span class="line">            <span class="variable">$repository</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$key</span>, <span class="keyword">require</span> <span class="variable">$path</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getConfigurationFiles</span>(<span class="params">Application <span class="variable">$app</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$configPath</span> = <span class="title function_ invoke__">realpath</span>(<span class="variable">$app</span>-&gt;<span class="title function_ invoke__">configPath</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="title class_">Finder</span>::<span class="title function_ invoke__">create</span>()-&gt;<span class="title function_ invoke__">files</span>()-&gt;<span class="title function_ invoke__">name</span>(<span class="string">&#x27;*.php&#x27;</span>)-&gt;<span class="title function_ invoke__">in</span>(<span class="variable">$configPath</span>) <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable">$directory</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getNestedDirectory</span>(<span class="variable">$file</span>, <span class="variable">$configPath</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$files</span>[<span class="variable">$directory</span>.<span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">getRealPath</span>(), <span class="string">&#x27;.php&#x27;</span>)] = <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">getRealPath</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">ksort</span>(<span class="variable">$files</span>, SORT_NATURAL);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$files</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getNestedDirectory</span>(<span class="params"><span class="built_in">SplFileInfo</span> <span class="variable">$file</span>, <span class="variable">$configPath</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$directory</span> = <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">getPath</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$nested</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">str_replace</span>(<span class="variable">$configPath</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$directory</span>), DIRECTORY_SEPARATOR)) &#123;</span><br><span class="line">            <span class="variable">$nested</span> = <span class="title function_ invoke__">str_replace</span>(DIRECTORY_SEPARATOR, <span class="string">&#x27;.&#x27;</span>, <span class="variable">$nested</span>).<span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$nested</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>所有 「引导程序」列表功能如下：</p>
<ul>
<li>Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables : 环境检测，通过 DOTENV 组件将 .env 配置文件载入到 $_ENV 变量中；</li>
<li>Illuminate\Foundation\Bootstrap\LoadConfiguration : 加载配置文件，这个我们刚刚分析过；</li>
<li>Illuminate\Foundation\Bootstrap\HandleExceptions ： 异常处理；</li>
<li>Illuminate\Foundation\Bootstrap\RegisterFacades ： 注册 Facades，注册完成后可以以别名的方式访问具体的类；</li>
<li>Illuminate\Foundation\Bootstrap\RegisterProviders : 注册服务提供者，我们在 「2.2.1 创建应用实例」已经将基础服务提供者注册到 APP 容器。在这里我们会将配置在 app.php 文件夹下 providers 节点的服务器提供者注册到 APP 容器，供请求处理阶段使用；</li>
<li>Illuminate\Foundation\Bootstrap\BootProviders : 启动服务</li>
</ul>
<p>完成「引导程序」启动操作后，随机进入到请求处理阶段。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送请求至路由</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">Pipeline</span>(<span class="variable language_">$this</span>-&gt;app))</span><br><span class="line">                -&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$request</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">through</span>(<span class="variable">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">shouldSkipMiddleware</span>() ? [] : <span class="variable">$this</span>-&gt;middleware)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">then</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">dispatchToRouter</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 「发送请求至路由」这行代码中，完成了：管道（pipeline）创建、将 $request 传入管道、对 $request 执行「中间件」处理和实际的请求处理四个不同的操作。</p>
<p>在开始前我们需要知道在 Laravel 中有个「中间件」 的概念，即使你还不知道，也没关系，仅需知道它的功能是在处理请求操作之前，对请求进行过滤处理即可，仅当请求符合「中间件」的验证规则时才会继续执行后续处理。</p>
<p>那么，究竟一个请求是如何被处理的呢？</p>
<p>首先看看 $this-&gt;dispatchToRouter() 这句代码，它的方法声明如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$request</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;request&#x27;</span>, <span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;router-&gt;<span class="title function_ invoke__">dispatch</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回顾下「解析内核实例」章节，可知已经将 Illuminate\Routing\Router 对象赋值给 $this-&gt;router 属性。</p>
<p>通过 router 实例的 disptach() 方法去执行 HTTP 请求，在它的内部会完成如下处理：</p>
<ul>
<li>查找对应的路由实例</li>
<li>通过一个实例栈运行给定的路由</li>
<li>运行在 routes&#x2F;web.php 配置的匹配到的控制器或匿名函数</li>
<li>返回响应结果</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span> <span class="keyword">implements</span> <span class="title">BindingRegistrar</span>, <span class="title">RegistrarContract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;currentRequest = <span class="variable">$request</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">dispatchToRoute</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRoute</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">runRoute</span>(<span class="variable">$request</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">findRoute</span>(<span class="variable">$request</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">findRoute</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;current = <span class="variable">$route</span> = <span class="variable language_">$this</span>-&gt;routes-&gt;<span class="keyword">match</span>(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;container-&gt;<span class="title function_ invoke__">instance</span>(<span class="title class_">Route</span>::<span class="variable language_">class</span>, <span class="variable">$route</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$route</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRoute</span>(<span class="params">Request <span class="variable">$request</span>, Route <span class="variable">$route</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">setRouteResolver</span>(function () <span class="keyword">use</span> ($<span class="title">route</span>) &#123;</span><br><span class="line">            <span class="title">return</span> $<span class="title">route</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;events-&gt;<span class="title function_ invoke__">dispatch</span>(<span class="keyword">new</span> <span class="title class_">RouteMatched</span>(<span class="variable">$route</span>, <span class="variable">$request</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">prepareResponse</span>(<span class="variable">$request</span>,</span><br><span class="line">            <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">runRouteWithinStack</span>(<span class="variable">$route</span>, <span class="variable">$request</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRouteWithinStack</span>(<span class="params">Route <span class="variable">$route</span>, Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$shouldSkipMiddleware</span> = <span class="variable language_">$this</span>-&gt;container-&gt;<span class="title function_ invoke__">bound</span>(<span class="string">&#x27;middleware.disable&#x27;</span>) &amp;&amp;</span><br><span class="line">                                <span class="variable language_">$this</span>-&gt;container-&gt;<span class="title function_ invoke__">make</span>(<span class="string">&#x27;middleware.disable&#x27;</span>) === <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$middleware</span> = <span class="variable">$shouldSkipMiddleware</span> ? [] : <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">gatherRouteMiddleware</span>(<span class="variable">$route</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">Pipeline</span>(<span class="variable language_">$this</span>-&gt;container))</span><br><span class="line">                        -&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$request</span>)</span><br><span class="line">                        -&gt;<span class="title function_ invoke__">through</span>(<span class="variable">$middleware</span>)</span><br><span class="line">                        -&gt;<span class="title function_ invoke__">then</span>(function (<span class="variable">$request</span>) <span class="keyword">use</span> ($<span class="title">route</span>) &#123;</span><br><span class="line">                            <span class="title">return</span> $<span class="title">this</span>-&gt;<span class="title">prepareResponse</span>(</span><br><span class="line">                                $<span class="title">request</span>, $<span class="title">route</span>-&gt;<span class="title">run</span>()</span><br><span class="line">                            );</span><br><span class="line">                        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 $route-&gt;run() 的方法定义在 Illuminate\Routing\Route 类中，最终执行「在 routes&#x2F;web.php 配置的匹配到的控制器或匿名函数」：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;container = <span class="variable language_">$this</span>-&gt;container ?: <span class="keyword">new</span> <span class="title class_">Container</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isControllerAction</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">runController</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">runCallable</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (HttpResponseException <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getResponse</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分如果路由的实现是一个控制器，会完成控制器实例化并执行指定方法；如果是一个匿名函数则直接调用这个匿名函数。</p>
<p>其执行结果会通过 Illuminate\Routing\Router::prepareResponse($request, $response) 生一个响应实例并返回。</p>
<p>至此，Laravel 就完成了一个 HTTP 请求的请求处理。</p>
<h2 id="发送响应"><a href="#发送响应" class="headerlink" title="发送响应"></a>发送响应</h2><p>经过一系列漫长的操作，HTTP 请求进入的最终章 - 发送响应值客户端 $response-&gt;send()。<br>发送响应由 Illuminate\Http\Response 父类 Symfony\Component\HttpFoundation\Response 中的 send() 方法完成。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendHeaders</span>();<span class="comment">// 发送响应头部信息</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendContent</span>();<span class="comment">// 发送报文主题</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (\<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;fastcgi_finish_request&#x27;</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">fastcgi_finish_request</span>();</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!\<span class="title function_ invoke__">in_array</span>(\PHP_SAPI, [<span class="string">&#x27;cli&#x27;</span>, <span class="string">&#x27;phpdbg&#x27;</span>], <span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="built_in">static</span>::<span class="title function_ invoke__">closeOutputBuffers</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="终止程序"><a href="#终止程序" class="headerlink" title="终止程序"></a>终止程序</h2><p>程序终止，完成终止中间件的调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">terminate</span>(<span class="params"><span class="variable">$request</span>, <span class="variable">$response</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">terminateMiddleware</span>(<span class="variable">$request</span>, <span class="variable">$response</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">terminate</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 终止中间件</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">terminateMiddleware</span>(<span class="params"><span class="variable">$request</span>, <span class="variable">$response</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$middlewares</span> = <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">shouldSkipMiddleware</span>() ? [] : <span class="title function_ invoke__">array_merge</span>(</span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">gatherRouteMiddleware</span>(<span class="variable">$request</span>),</span><br><span class="line">        <span class="variable">$this</span>-&gt;middleware</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$middlewares</span> <span class="keyword">as</span> <span class="variable">$middleware</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="title function_ invoke__">is_string</span>(<span class="variable">$middleware</span>)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="variable">$name</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseMiddleware</span>(<span class="variable">$middleware</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$instance</span> = <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">make</span>(<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$instance</span>, <span class="string">&#x27;terminate&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$instance</span>-&gt;<span class="title function_ invoke__">terminate</span>(<span class="variable">$request</span>, <span class="variable">$response</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上便是 Laravel 的请求生命周期的始末。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在 「创建 Laravel 应用实例」时不仅会注册项目基础服务、注册项目服务提供者别名、注册目录路径等在内的一系列注册工作；还会绑定 HTTP 内核及 Console 内核到 APP 容器， 同时在 HTTP 内核里配置中间件和引导程序。</p>
<p>进入 「接收请求并响应」里，会依据运行环境从 APP 容器 解析出 HTTP 内核或 Console 内核。如果是 HTTP 内核，还将把「中间件」及「引导程序」注册到 APP 容器。</p>
<p>所有初始化工作完成后便进入「处理 HTTP 请求」阶段。</p>
<p>一个 Http 请求实例会被注册到 APP 容器，通过启动「引导程序」来设置环境变量、加载配置文件等等系统环境配置；</p>
<p>随后请求被分发到匹配的路由，在路由中执行「中间件」以过滤不满足校验规则的请求，只有通过「中间件」处理的请求才最终处理实际的控制器或匿名函数生成响应结果。</p>
<p>最后发送响应给用户，清理项目中的中间件，完成一个 「请求」 - 「响应」 的生命周期，之后我们的 Web 服务器将等待下一轮用户请求。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>原文作者：liuqing_hu</li>
<li>转自链接：<a target="_blank" rel="noopener" href="https://learnku.com/articles/10421/depth-mining-of-laravel-life-cycle">https://learnku.com/articles/10421/depth-mining-of-laravel-life-cycle</a></li>
</ul>

  </article>
</div>


    




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <div class="clearfix">
    <a href="https://b3296.github.io" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2019 Bxl</li>
      <li><a href="https://b3296.github.io">Home</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a target="_blank" rel="noopener" href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a target="_blank" rel="noopener" href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
    </div>
    
  </footer>
</div>




<script src="/js/main.js"></script>

</body>
</html>
